<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AI Tarot • Меню</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{ --bg:#070814; --text:#f4f1ff; --muted:#b7b3d6; --card:#0f1224; --border:rgba(255,255,255,.1); }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:760px;margin:0 auto;padding:18px}
    h1{margin:0 0 8px 0;font-size:22px}
    .muted{color:var(--muted);font-size:13px}
    .panel{margin-top:14px;padding:14px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.04)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{appearance:none;cursor:pointer;border:0;border-radius:12px;padding:12px 16px;font-weight:800}
    .btn{background:linear-gradient(90deg, #8c6bff, #39bdff);color:#fff}
    .ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .dbg{position:fixed;right:8px;bottom:8px;background:rgba(0,0,0,.45);border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:12px;color:#ddd;max-width:70vw;z-index:9}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Меню таро</h1>
    <div class="muted" id="user">@user</div>

    <div class="panel">
      <div class="row">
        <button class="btn"   id="btnBalance">Обновить баланс</button>
        <button class="ghost" id="btnPing">Пинг</button>
      </div>
    </div>

    <div class="panel">
      <div class="row">
        <button class="btn" data-act="card_of_day">Карта дня</button>
        <button class="btn" data-act="three">3 карты</button>
        <button class="btn" data-act="yes_no">Да / Нет</button>
        <button class="btn" data-act="week">Неделя</button>
      </div>
    </div>

    <div class="panel">
      <div class="row">
        <button class="ghost" data-buy="100">Купить 100</button>
        <button class="ghost" data-buy="300">Купить 300</button>
      </div>
    </div>
  </div>

  <div class="dbg" id="dbg">init…</div>

  <script>
    const tg = window.Telegram && window.Telegram.WebApp;
    const dbg = (t)=>{ const el = document.getElementById('dbg'); if (el) el.textContent = String(t); };
    function alertSafe(msg){ try{ tg.showAlert(String(msg)); }catch(_){ console.log("ALERT:", msg); } dbg(msg); }

    // Критично: отправить и СРАЗУ закрыть WebApp, чтобы событие пришло в чат (Desktop/Mobile).
    function send(action, extra = {}) {
      const payload = JSON.stringify({ action, ...extra });
      try { tg.sendData(payload); } catch (e) { alertSafe("sendData error: " + (e?.message || e)); return; }
      try { tg.close(); } catch (_) {}
    }

    function bindClicks(){
      document.getElementById('btnPing')?.addEventListener('click', ()=> send('ping', {ts: Date.now()}));
      document.getElementById('btnBalance')?.addEventListener('click', ()=> send('balance'));

      document.querySelectorAll('[data-act]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const act = btn.getAttribute('data-act');
          if (act === 'yes_no') {
            const q = prompt('Введите ваш вопрос (Да/Нет):');
            if (!q) return;
            return send('yes_no', {question: q});
          }
          return send(act);
        });
      });

      document.querySelectorAll('[data-buy]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const qty = parseInt(btn.getAttribute('data-buy'), 10) || 100;
          return send('buy', {qty});
        });
      });
    }

    function init(){
      try {
        tg.ready();
        tg.expand();
        // Не включаем подтверждение закрытия, чтобы close() сработал без диалога:
        // tg.enableClosingConfirmation();
        try {
          const u = tg.initDataUnsafe?.user;
          if (u) document.getElementById('user').textContent = `@${u.username || 'user'} • id ${u.id}`;
        } catch(_){}
        bindClicks();
        alertSafe("WebApp готов");
      } catch (e) {
        console.error("TG init error", e);
        dbg("TG init error: " + (e?.message || e));
      }
    }

    document.addEventListener('DOMContentLoaded', init);
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      setTimeout(init, 0);
    }
  </script>
</body>
</html>
